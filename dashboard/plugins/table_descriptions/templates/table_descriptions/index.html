{% extends 'layouts/base.html' %}
{% import 'macros/common.html' as common with context %}


{% block autorefresh %}{% endblock %}

{% block title %}Table {% endblock %}

{% block nav %}
    <li class="breadcrumb-item"><a href="/">Home</a></li>
    <li class="breadcrumb-item active">Tables dashboard</li>
{% endblock %}

{% block body %}

    <link href="{{ url_for('static', filename='css/descriptions.css') }}" rel="stylesheet">

    <div id="tooling">
        <div id="search">
            <input placeholder="&#x1F50D; Search"/>
            <div id="clear-search-container">
                <p id="clear-search">&times;</p>
            </div>
        </div>
        <div id="legend">
            Legend: <span class="cui-layers" aria-hidden="true"></span> Partition column
        </div>
    </div>

    <div id="table-container">
        <div class="row mt-3 table-header">
            <div class="col-3">
                <span id="all-toggle" class="toggle"><span class="cui-chevron-right" aria-hidden="true"></span></span>
                Database | Table name
            </div>
            <div class="col-9">Description</div>
        </div>
        {% for table_name, details in tables.items() %}
            {% set edit_columns_loop = loop %}

            <div id="{{ table_name }}" class="table-data">
                <div id="header-{{ table_name }}" class="row column-header-section">
                    <div class="col-3">
                        <span style="white-space: nowrap;">
                            <span id="toggle-{{ table_name }}" class="toggle row-toggle">
                                <span class="cui-chevron-right" aria-hidden="true"></span>
                            </span>
                            {{ table_name }}
                        </span>
                    </div>
                    <div class="col-9">{{ details.description }} <a href="/table_descriptions/update_form_table?table_name={{ table_name | splitpart(1, '.') }}&namespace={{ table_name | splitpart(0, '.') }}&old_description={{ details.description }}"> <img src="http://icons.iconarchive.com/icons/custom-icon-design/mono-general-2/256/edit-icon.png" alt="Edit icon" style="width:15px;height:15px"></a>  </div>
                </div>
                <div class="row column-data-section" id="columns_{{ table_name }}">
                    <div class="row table-columns-header">
                        <div class="col-3">Column</div>
                        <div class="col-3">Type</div>
                        <div class="col-3">Description</div>
                        <div class="col-3">Example</div>
                    </div>
                    {% for column in details.columns %}
                        <div class="row column-data">
                            <div class="col-3">{{ column.name }} {% if column.is_partition %}<span class="cui-layers" aria-hidden="true"></span>{% endif %}</div>
                            <div class="col-3">{{ column.type }} </div>
                            <div class="col-3">{{ column.description }}  <br><i>{% if column.last_description_update %} {{ column.last_description_update }} {% else %} Sourced from SQL {% endif %} </i> <a href="/table_descriptions/update_form_column?table_name={{ table_name | splitpart(1, '.') }}&namespace={{ table_name | splitpart(0, '.') }}&column_name={{ column.name }}&old_description={{ column.description }}&old_example={{ column.example }}"> <img src="http://icons.iconarchive.com/icons/custom-icon-design/mono-general-2/256/edit-icon.png" alt="Edit icon" style="width:15px;height:15px"></a> </div>
                            <div class="col-3">{{ column.example }} </div>
                            <div class="col-3 button-edit" id="button-edit-{{ '%s' % loop.index }}">
                                <img src="http://icons.iconarchive.com/icons/custom-icon-design/mono-general-2/256/edit-icon.png" alt="Image">
                                <button class="btn">Button</button>
                                <script>
                                    document.getElementById("#button-edit-{{ '%s' % edit_columns_loop }}-{{ '%s' % loop.index }}").onclick = function(){
                                        document.getElementById("form-update-column-{{ '%s' % edit_columns_loop }}-{{ '%s' % loop.index }}").style.display="block";
                                    };
                                </script>
                            </div>
                            <form action="/table_descriptions/post_update_column" id="form-update-column-{{ '%s' % edit_columns_loop }}-{{ '%s' % loop.index }}" style="visibility: hidden;">
                                Column description:<br>
                                <input type="text" name="column_description" value="{{ column.description }}">
                                <br>
                                Example:<br>
                                <input type="text" name="example" value="{{ column.example}}">
                                <br><br>
                                <input type="hidden" name="namespace" value="{{ table_name | splitpart(0, '.') }}">
                                <input type="hidden" name="table_name" value="{{ table_name | splitpart(1, '.') }}">
                                <input type="hidden" name="column" value="{{ column.name }}">
                                <input type="submit" value="Submit">
                            </form>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endfor %}
    </div>

{% endblock %}

{% block charts %}
    <script src="{{ url_for('static', filename='js/search.js') }}"></script>
    <script src="{{ url_for('static', filename='js/highlight.js') }}"></script>
    <script src="{{ url_for('static', filename='js/render_vis.js') }}"></script>
    <script>
        const collapsed_char = '<span class="cui-chevron-right" aria-hidden="true"></span>';
        const expanded_char = '<span class="cui-chevron-bottom" aria-hidden="true"></span>';


        expand_all = function () {
            $(".column-data-section").css("display", "block");
            $(".row-toggle").html(expanded_char);
            $("#all-toggle").html(expanded_char);
        };

        collapse_all = function () {
            $(".column-data-section").css("display", "none");
            $(".row-toggle").html(collapsed_char);
            $("#all-toggle").html(collapsed_char);
        };

        const search = new SearchProvider('.table-data');
        search.onSearchPhraseChanged = expand_all;
        search.main();

        window.onload = checkHighlight;

        //toggle visibility of a single row
        $(".column-header-section").click(function (event) {
            const tableName = $(this).attr('id').substr('header-'.length).replace(".", "\\.");
            const idColumns = "#columns_" + tableName;
            const idToggle = "#toggle-" + tableName;
            if ($(idToggle).html() === collapsed_char) {
                $(idColumns).css("display", "block");
                $(idToggle).html(expanded_char)
            } else {
                $(idColumns).css("display", "none");
                $(idToggle).html(collapsed_char)
            }
        });

        //toggle visibility of all rows
        $(".table-header").click(function (event) {
            if ($('#all-toggle').html() === collapsed_char) {
                expand_all();
            } else {
                collapse_all();
            }
        });
    </script>
{% endblock %}
